<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Шаблон проекта · М²</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f5f0ea;--surface:#faf8f5;--border:#e8e0d4;--accent:#8a7055;--dark:#2c2419;--text:#1a1510;--mid:#7a6e62;--light:#a89e90;--ok:#6b8f6b;--err:#c0392b}
body{font-family:'Jost',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.serif{font-family:'Cormorant Garamond',serif}
.header{background:var(--dark);padding:0 40px;height:56px;display:flex;align-items:center;justify-content:space-between}
.header-logo{font-family:'Cormorant Garamond',serif;color:#c4a882;font-size:20px;letter-spacing:2px}
.header-title{font-size:11px;color:#7a6e62;letter-spacing:3px}
.layout{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 56px)}
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:32px 0}
.sidebar-label{font-size:10px;letter-spacing:3px;color:var(--light);margin-bottom:12px;padding:0 24px}
.step-item{display:flex;align-items:center;gap:12px;padding:10px 24px;cursor:pointer;border-left:2px solid transparent;transition:background .2s}
.step-item:hover{background:var(--bg)}
.step-item.active{background:var(--bg);border-left-color:var(--accent)}
.step-item.done .step-num{background:var(--ok);color:#fff}
.step-num{width:24px;height:24px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--mid);flex-shrink:0;transition:all .2s}
.step-item.active .step-num{background:var(--accent);color:#fff}
.step-name{font-size:13px;color:var(--mid)}
.step-item.active .step-name{color:var(--text);font-weight:500}
.main{padding:48px 56px;max-width:820px}
.page-title{font-size:36px;font-weight:300;margin-bottom:6px}
.page-sub{font-size:14px;color:var(--light);margin-bottom:40px;line-height:1.6}
.section{display:none}.section.active{display:block}
.field-group{margin-bottom:28px}
.field-label{font-size:10px;letter-spacing:2px;color:var(--light);margin-bottom:10px;display:block}
.field-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:12px 16px;color:var(--text);font-size:14px;font-family:'Jost',sans-serif;outline:none;transition:border-color .2s}
.field-input:focus{border-color:var(--accent)}
textarea.field-input{resize:none;height:80px}
.toggle-block{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:4px 20px;margin-bottom:12px}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.toggle-row:last-child{border-bottom:none}
.toggle-info{flex:1}
.toggle-label{font-size:14px}
.toggle-sub{font-size:12px;color:var(--light);margin-top:2px}
.toggle{width:40px;height:22px;background:var(--border);border-radius:11px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;margin-left:16px}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left .2s}
.toggle.on::after{left:20px}
.drawings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.drawing-chip{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:12px 16px;cursor:pointer;transition:all .2s;font-size:13px;color:var(--mid);display:flex;justify-content:space-between;align-items:center}
.drawing-chip:hover{border-color:var(--accent)}
.drawing-chip.selected{border-color:var(--accent);background:var(--bg);color:var(--text)}
.chip-check{color:var(--accent);display:none}
.drawing-chip.selected .chip-check{display:inline}
.tz-cards{display:flex;flex-direction:column;gap:10px}
.tz-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:20px 24px;cursor:pointer;transition:all .2s;display:flex;align-items:flex-start;gap:16px}
.tz-card:hover{border-color:var(--accent)}
.tz-card.selected{border-color:var(--accent);background:var(--bg)}
.tz-card-radio{width:18px;height:18px;border:1.5px solid var(--border);border-radius:50%;flex-shrink:0;margin-top:2px;transition:all .2s;position:relative}
.tz-card.selected .tz-card-radio{border-color:var(--accent);background:var(--accent)}
.tz-card.selected .tz-card-radio::after{content:'';position:absolute;width:6px;height:6px;background:#fff;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%)}
.tz-card-title{font-size:15px;margin-bottom:4px}
.tz-card-sub{font-size:12px;color:var(--light);line-height:1.6}

/* ШАБЛОНЫ СПИСОК */
.tpl-row{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:18px 24px;margin-bottom:10px}
.tpl-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.tpl-name{font-size:15px;font-weight:400}
.tpl-meta{font-size:12px;color:var(--light);margin-top:3px}
.tpl-actions{display:flex;gap:8px;flex-shrink:0}
.tpl-btn{background:none;border:1px solid var(--border);color:var(--mid);padding:6px 14px;border-radius:3px;cursor:pointer;font-size:11px;font-family:'Jost',sans-serif;transition:all .2s}
.tpl-btn:hover{border-color:var(--accent);color:var(--accent)}
.tpl-btn.del:hover{border-color:var(--err);color:var(--err)}
.tpl-btn.copy{background:var(--dark);border-color:var(--dark);color:var(--bg)}
.tpl-btn.copy:hover{background:var(--accent);border-color:var(--accent)}

/* ССЫЛКА */
.link-box{background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:10px 14px;font-size:12px;color:var(--mid);font-family:monospace;word-break:break-all;margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.link-text{flex:1;font-size:11px}
.link-copy{background:none;border:none;color:var(--accent);cursor:pointer;font-size:11px;font-family:'Jost',sans-serif;white-space:nowrap}
.link-copy:hover{color:var(--dark)}
.copied-badge{font-size:11px;color:var(--ok);margin-left:8px;opacity:0;transition:opacity .3s}
.copied-badge.show{opacity:1}

.q-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.q-text{flex:1;font-size:13px;color:var(--mid)}
.q-del{background:none;border:none;color:var(--light);cursor:pointer;font-size:16px;padding:0 4px}
.q-del:hover{color:var(--err)}
.q-add-row{display:flex;gap:10px;margin-top:12px}
.btn-row{display:flex;gap:12px;margin-top:40px;padding-top:32px;border-top:1px solid var(--border)}
.btn-back{background:none;border:1px solid var(--border);color:var(--mid);padding:12px 28px;border-radius:3px;cursor:pointer;font-size:12px;font-family:'Jost',sans-serif;transition:all .2s}
.btn-back:hover{border-color:var(--accent);color:var(--accent)}
.btn-next{background:var(--dark);border:none;color:var(--bg);padding:12px 36px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;font-family:'Jost',sans-serif;transition:background .2s}
.btn-next:hover{background:var(--accent)}
.btn-save{background:var(--accent);border:none;color:#fff;padding:12px 36px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;font-family:'Jost',sans-serif;transition:background .2s}
.btn-save:hover{background:var(--dark)}
.btn-new{background:var(--dark);border:none;color:var(--bg);padding:12px 28px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;font-family:'Jost',sans-serif}
.sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px}
.sum-block{background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:16px 20px}
.sum-block.full{grid-column:1/-1}
.sum-key{font-size:10px;letter-spacing:2px;color:var(--light);margin-bottom:6px}
.sum-val{font-size:13px;line-height:1.6}
.upload-area{border:1.5px dashed var(--border);border-radius:3px;padding:32px;text-align:center;cursor:pointer;transition:border-color .2s;background:var(--surface)}
.upload-area:hover{border-color:var(--accent)}

/* LOADER */
.saving-overlay{position:fixed;inset:0;background:rgba(44,36,25,.5);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.saving-box{background:var(--surface);border-radius:3px;padding:32px 48px;text-align:center}
.saving-text{font-size:14px;color:var(--mid);margin-top:12px}
</style>
</head>
<body>

<div class="saving-overlay" id="saving-overlay">
  <div class="saving-box">
    <div style="font-size:24px">⟳</div>
    <div class="saving-text" id="saving-text">Сохранение...</div>
  </div>
</div>

<div class="header">
  <div class="header-logo serif">М²</div>
  <div class="header-title">КОНСТРУКТОР ШАБЛОНОВ</div>
  <div style="font-size:12px;color:#7a6e62">
    <span id="save-status"></span>
  </div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-label">ШАГИ НАСТРОЙКИ</div>
    <div class="step-item active" data-step="0"><div class="step-num">◈</div><div class="step-name">Мои шаблоны</div></div>
    <div class="step-item" data-step="1"><div class="step-num">1</div><div class="step-name">Название</div></div>
    <div class="step-item" data-step="2"><div class="step-num">2</div><div class="step-name">Чертежи проекта</div></div>
    <div class="step-item" data-step="3"><div class="step-num">3</div><div class="step-name">Визуализация и прочее</div></div>
    <div class="step-item" data-step="4"><div class="step-num">4</div><div class="step-name">Эталон ТЗ</div></div>
    <div class="step-item" data-step="5"><div class="step-num">5</div><div class="step-name">Вопросы КУБа</div></div>
    <div class="step-item" data-step="6"><div class="step-num">6</div><div class="step-name">Итог</div></div>
  </div>

  <div class="main">

    <!-- 0: МОИ ШАБЛОНЫ -->
    <div class="section active" id="step-0">
      <div class="serif page-title">Мои шаблоны</div>
      <div class="page-sub">Каждый шаблон генерирует уникальную ссылку для клиента.<br>Клиент переходит по ссылке и проходит КУБ — без регистрации.</div>
      <div id="templates-list" style="margin-bottom:24px">
        <div style="color:var(--light);font-size:14px;padding:16px 0">Загрузка шаблонов...</div>
      </div>
      <button class="btn-new" onclick="newTemplate()">+ СОЗДАТЬ ШАБЛОН</button>
    </div>

    <!-- 1: НАЗВАНИЕ -->
    <div class="section" id="step-1">
      <div class="serif page-title">Название шаблона</div>
      <div class="page-sub">Дайте шаблону понятное название — по нему вы будете выбирать его при работе с клиентом.</div>
      <div class="field-group">
        <label class="field-label">НАЗВАНИЕ</label>
        <input class="field-input" id="tpl-name" placeholder="Например: Полный проект · Без визуализации · Только кухня">
      </div>
      <div class="field-group">
        <label class="field-label">ОПИСАНИЕ (необязательно)</label>
        <textarea class="field-input" id="tpl-desc" placeholder="В каких случаях использовать этот шаблон..."></textarea>
      </div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(0)">НАЗАД</button>
        <button class="btn-next" onclick="goStep(2)">ДАЛЕЕ →</button>
      </div>
    </div>

    <!-- 2: ЧЕРТЕЖИ -->
    <div class="section" id="step-2">
      <div class="serif page-title">Чертежи проекта</div>
      <div class="page-sub">Отметьте какие чертежи входят в ваш проект.<br>КУБ будет собирать информацию именно под этот состав.</div>
      <div class="field-group">
        <label class="field-label">СОСТАВ ЧЕРТЕЖЕЙ</label>
        <div class="drawings-grid">
          <div class="drawing-chip selected" data-d="plan-layout" onclick="this.classList.toggle('selected')">План расстановки мебели <span class="chip-check">✓</span></div>
          <div class="drawing-chip selected" data-d="plan-walls" onclick="this.classList.toggle('selected')">Монтаж стен и перегородок <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-floor" onclick="this.classList.toggle('selected')">Напольные покрытия <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-ceiling" onclick="this.classList.toggle('selected')">План потолков <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-electric" onclick="this.classList.toggle('selected')">План электрики <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-lighting" onclick="this.classList.toggle('selected')">План освещения <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-outlets" onclick="this.classList.toggle('selected')">Розетки и выключатели <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-plumbing" onclick="this.classList.toggle('selected')">План сантехники <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-heating" onclick="this.classList.toggle('selected')">План отопления <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-tiles" onclick="this.classList.toggle('selected')">Раскладка плитки <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-walls-view" onclick="this.classList.toggle('selected')">Развёртки стен <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-axo" onclick="this.classList.toggle('selected')">Аксонометрия <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-demo" onclick="this.classList.toggle('selected')">План демонтажа <span class="chip-check">✓</span></div>
          <div class="drawing-chip" data-d="plan-doors" onclick="this.classList.toggle('selected')">Расстановка дверей <span class="chip-check">✓</span></div>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">СВОИ ЧЕРТЕЖИ</label>
        <div id="extra-drawings-list"></div>
        <div class="q-add-row">
          <input class="field-input" id="extra-drawing-input" placeholder="Например: план вентиляции...">
          <button class="btn-save" onclick="addExtraDrawing()" style="padding:12px 20px;white-space:nowrap">+ ДОБАВИТЬ</button>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(1)">НАЗАД</button>
        <button class="btn-next" onclick="goStep(3)">ДАЛЕЕ →</button>
      </div>
    </div>

    <!-- 3: ВИЗУАЛИЗАЦИЯ -->
    <div class="section" id="step-3">
      <div class="serif page-title">Визуализация и прочее</div>
      <div class="page-sub">Что ещё входит в ваш проект помимо чертежей?</div>
      <div class="field-group">
        <label class="field-label">ВИЗУАЛИЗАЦИЯ</label>
        <div class="toggle-block">
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">3D-визуализация</div><div class="toggle-sub">Фотореалистичные рендеры помещений</div></div><div class="toggle" id="tog-vis3d" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Коллаж / мудборд</div><div class="toggle-sub">Подборка референсов, материалов, цветов</div></div><div class="toggle on" id="tog-collage" onclick="this.classList.toggle('on')"></div></div>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">СПЕЦИФИКАЦИИ И СМЕТЫ</label>
        <div class="toggle-block">
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Спецификация мебели</div><div class="toggle-sub">Список мебели с артикулами и ценами</div></div><div class="toggle on" id="tog-spec-furniture" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Спецификация материалов</div><div class="toggle-sub">Отделочные материалы и покрытия</div></div><div class="toggle" id="tog-spec-materials" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Спецификация освещения</div><div class="toggle-sub">Светильники с артикулами и ссылками</div></div><div class="toggle" id="tog-spec-light" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Сметный расчёт работ</div><div class="toggle-sub">Ориентировочная стоимость ремонта</div></div><div class="toggle" id="tog-estimate" onclick="this.classList.toggle('on')"></div></div>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">СОПРОВОЖДЕНИЕ</label>
        <div class="toggle-block">
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Авторский надзор</div><div class="toggle-sub">Контроль реализации проекта на объекте</div></div><div class="toggle" id="tog-supervision" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Управление закупками</div><div class="toggle-sub">Помощь при выборе и закупке</div></div><div class="toggle" id="tog-purchase" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Управление ремонтом</div><div class="toggle-sub">Организация и контроль строительных работ</div></div><div class="toggle" id="tog-build" onclick="this.classList.toggle('on')"></div></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(2)">НАЗАД</button>
        <button class="btn-next" onclick="goStep(4)">ДАЛЕЕ →</button>
      </div>
    </div>

    <!-- 4: ЭТАЛОН ТЗ -->
    <div class="section" id="step-4">
      <div class="serif page-title">Эталон ТЗ</div>
      <div class="page-sub">На основе какого образца КУБ будет формировать техническое задание?</div>
      <div class="field-group">
        <div class="tz-cards">
          <div class="tz-card selected" data-tz="m2" onclick="selectTZ(this,'m2')">
            <div class="tz-card-radio"></div>
            <div><div class="tz-card-title">Стандарт М²</div><div class="tz-card-sub">Профессиональный шаблон от платформы М². Все разделы: описание объекта, стиль, материалы, помещения, технические системы.</div></div>
          </div>
          <div class="tz-card" data-tz="upload" onclick="selectTZ(this,'upload')">
            <div class="tz-card-radio"></div>
            <div><div class="tz-card-title">Мой образец ТЗ</div><div class="tz-card-sub">Загрузите свой шаблон. КУБ будет формировать ТЗ в вашем формате и структуре.</div></div>
          </div>
          <div class="tz-card" data-tz="hybrid" onclick="selectTZ(this,'hybrid')">
            <div class="tz-card-radio"></div>
            <div><div class="tz-card-title">Гибридный вариант</div><div class="tz-card-sub">Стандарт М² как основа с вашими дополнениями и изменениями структуры.</div></div>
          </div>
        </div>
      </div>
      <div id="upload-area-wrap" style="display:none;margin-top:16px">
        <div class="upload-area" onclick="document.getElementById('tz-file').click()">
          <div style="font-size:28px;color:var(--light);margin-bottom:10px">↑</div>
          <div style="font-size:13px;color:var(--mid)">Нажмите для загрузки вашего ТЗ</div>
          <div style="font-size:11px;color:var(--light);margin-top:4px">Форматы: .docx, .pdf</div>
        </div>
        <input type="file" id="tz-file" accept=".docx,.pdf" style="display:none" onchange="handleTZUpload(this)">
        <div id="tz-file-name" style="font-size:12px;color:var(--ok);margin-top:8px"></div>
      </div>
      <div id="hybrid-area-wrap" style="display:none;margin-top:16px">
        <label class="field-label">ВАШИ ДОПОЛНЕНИЯ К СТАНДАРТУ М²</label>
        <textarea class="field-input" id="hybrid-notes" placeholder="Что нужно добавить или изменить..." style="height:100px"></textarea>
      </div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(3)">НАЗАД</button>
        <button class="btn-next" onclick="goStep(5)">ДАЛЕЕ →</button>
      </div>
    </div>

    <!-- 5: ВОПРОСЫ -->
    <div class="section" id="step-5">
      <div class="serif page-title">Вопросы КУБа</div>
      <div class="page-sub">Настройте какие блоки анкеты КУБ задаёт клиенту.<br>Добавьте свои вопросы если есть специфика.</div>
      <div class="field-group">
        <label class="field-label">СТАНДАРТНЫЕ БЛОКИ АНКЕТЫ М²</label>
        <div class="toggle-block">
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Психология и образ жизни</div><div class="toggle-sub">Планы семьи, аллергии, гости, домашние животные, работа дома</div></div><div class="toggle on" id="b-psychology" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Состав семьи и биоритм</div><div class="toggle-sub">Кто живёт, возраст, хобби, режим дня, рост</div></div><div class="toggle on" id="b-family" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Перепланировка</div><div class="toggle-sub">Объединение зон, балконы, изменение стен</div></div><div class="toggle on" id="b-replan" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Инженерные системы</div><div class="toggle-sub">Тёплые полы, кондиционирование, интернет</div></div><div class="toggle on" id="b-engineering" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Бюджет детально</div><div class="toggle-sub">Мебель, сантехника, двери, материалы — диапазоны</div></div><div class="toggle on" id="b-budget" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Стиль и референсы</div><div class="toggle-sub">Предпочтения по стилю, антистиль, цвета, металл</div></div><div class="toggle on" id="b-style" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Материалы и отделка</div><div class="toggle-sub">Стены, пол, потолок — предпочтения</div></div><div class="toggle on" id="b-materials" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Детализация по помещениям</div><div class="toggle-sub">Наполнение, освещение, пожелания для каждой зоны</div></div><div class="toggle on" id="b-rooms" onclick="this.classList.toggle('on')"></div></div>
          <div class="toggle-row"><div class="toggle-info"><div class="toggle-label">Услуги сопровождения</div><div class="toggle-sub">Предложить авторский надзор, сметы, закупки</div></div><div class="toggle" id="b-services" onclick="this.classList.toggle('on')"></div></div>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">МОИ ВОПРОСЫ</label>
        <div id="q-list" style="margin-bottom:4px"></div>
        <div class="q-add-row">
          <input class="field-input" id="new-q" placeholder="Введите свой вопрос для КУБа...">
          <button class="btn-save" onclick="addQuestion()" style="padding:12px 20px;white-space:nowrap">+ ДОБАВИТЬ</button>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(4)">НАЗАД</button>
        <button class="btn-next" onclick="goStep(6)">ДАЛЕЕ →</button>
      </div>
    </div>

    <!-- 6: ИТОГ -->
    <div class="section" id="step-6">
      <div class="serif page-title">Итог шаблона</div>
      <div class="page-sub">Проверьте настройки и сохраните шаблон.</div>
      <div class="sum-grid" id="summary-grid"></div>
      <div class="btn-row">
        <button class="btn-back" onclick="goStep(5)">НАЗАД</button>
        <button class="btn-save" onclick="saveTemplate()">СОХРАНИТЬ ШАБЛОН</button>
      </div>
    </div>

  </div>
</div>

<script>
// ═══════════════════════════════════════════
// КОНФИГ — вставь свой ключ
// ═══════════════════════════════════════════
var JB_KEY = (typeof window.JB_KEY !== 'undefined') ? window.JB_KEY : 'ВСТАВЬ_КЛЮЧ';
var JB_TPL = '6999fdfcae596e708f3d7440'; // корзина шаблонов
var BASE_URL = 'https://m2designai-coder.github.io/m2-platform-/kub.html';

// ═══════════════════════════════════════════
// СОСТОЯНИЕ
// ═══════════════════════════════════════════
var currentStep = 0;
var selectedTZ = 'm2';
var customQuestions = [];
var extraDrawings = [];
var templates = [];
var editingIndex = -1;

var DRAWING_NAMES = {
  'plan-layout':'Расстановка мебели','plan-walls':'Монтаж стен',
  'plan-floor':'Напольные покрытия','plan-ceiling':'Потолки',
  'plan-electric':'Электрика','plan-lighting':'Освещение',
  'plan-outlets':'Розетки','plan-plumbing':'Сантехника',
  'plan-heating':'Отопление','plan-tiles':'Раскладка плитки',
  'plan-walls-view':'Развёртки стен','plan-axo':'Аксонометрия',
  'plan-demo':'Демонтаж','plan-doors':'Двери'
};
var TZ_NAMES = {m2:'Стандарт М²', upload:'Мой образец', hybrid:'Гибридный'};

// ═══════════════════════════════════════════
// JSONBIN
// ═══════════════════════════════════════════
async function loadTemplates() {
  try {
    var r = await fetch('https://api.jsonbin.io/v3/b/' + JB_TPL + '/latest', {
      headers: {'X-Master-Key': JB_KEY}
    });
    var d = await r.json();
    templates = d.record.templates || [];
    renderTemplates();
  } catch(e) {
    templates = [];
    renderTemplates();
  }
}

async function saveToJB() {
  showSaving('Сохранение...');
  try {
    await fetch('https://api.jsonbin.io/v3/b/' + JB_TPL, {
      method: 'PUT',
      headers: {'X-Master-Key': JB_KEY, 'Content-Type': 'application/json'},
      body: JSON.stringify({templates: templates})
    });
    hideSaving();
    document.getElementById('save-status').textContent = '✓ Сохранено';
    setTimeout(function(){document.getElementById('save-status').textContent='';}, 2000);
  } catch(e) {
    hideSaving();
    alert('Ошибка сохранения. Проверьте ключ JSONBin.');
  }
}

function showSaving(txt) {
  document.getElementById('saving-text').textContent = txt;
  document.getElementById('saving-overlay').style.display = 'flex';
}
function hideSaving() {
  document.getElementById('saving-overlay').style.display = 'none';
}

// ═══════════════════════════════════════════
// НАВИГАЦИЯ
// ═══════════════════════════════════════════
function goStep(n) {
  document.getElementById('step-'+currentStep).classList.remove('active');
  document.getElementById('step-'+n).classList.add('active');
  document.querySelectorAll('.step-item').forEach(function(el,i){
    el.classList.remove('active','done');
    if(i===n) el.classList.add('active');
    else if(i<n && i>0) el.classList.add('done');
  });
  currentStep = n;
  if(n === 6) buildSummary();
  if(n === 0) renderTemplates();
}

// ═══════════════════════════════════════════
// ШАБЛОНЫ
// ═══════════════════════════════════════════
function renderTemplates() {
  var list = document.getElementById('templates-list');
  if(!templates.length) {
    list.innerHTML = '<div style="color:var(--light);font-size:14px;padding:16px 0">У вас пока нет шаблонов</div>';
    return;
  }
  list.innerHTML = templates.map(function(t,i){
    var link = BASE_URL + '?tpl=' + t.id;
    var drawings = t.drawings ? t.drawings.length : 0;
    return '<div class="tpl-row">' +
      '<div class="tpl-top">' +
        '<div><div class="tpl-name">'+t.name+'</div>' +
        '<div class="tpl-meta">ТЗ: '+TZ_NAMES[t.tz||'m2']+' · Чертежей: '+drawings+'</div></div>' +
        '<div class="tpl-actions">' +
          '<button class="tpl-btn" onclick="editTemplate('+i+')">ИЗМЕНИТЬ</button>' +
          '<button class="tpl-btn del" onclick="deleteTemplate('+i+')">УДАЛИТЬ</button>' +
        '</div>' +
      '</div>' +
      '<div style="font-size:11px;color:var(--light);margin-bottom:6px;letter-spacing:1px">ССЫЛКА ДЛЯ КЛИЕНТА</div>' +
      '<div class="link-box">' +
        '<span class="link-text">'+link+'</span>' +
        '<button class="link-copy" onclick="copyLink(\''+link+'\', this)">СКОПИРОВАТЬ</button>' +
        '<span class="copied-badge" id="copied-'+i+'">Скопировано!</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

function copyLink(link, btn) {
  navigator.clipboard.writeText(link).then(function(){
    var badge = btn.nextElementSibling;
    badge.classList.add('show');
    setTimeout(function(){ badge.classList.remove('show'); }, 2000);
  });
}

function newTemplate() {
  editingIndex = -1;
  document.getElementById('tpl-name').value = '';
  document.getElementById('tpl-desc').value = '';
  selectedTZ = 'm2';
  customQuestions = [];
  extraDrawings = [];
  document.querySelectorAll('.drawing-chip').forEach(function(c){
    c.classList.toggle('selected', ['plan-layout','plan-walls'].includes(c.dataset.d));
  });
  document.querySelectorAll('.tz-card').forEach(function(c){
    c.classList.toggle('selected', c.dataset.tz === 'm2');
  });
  document.getElementById('upload-area-wrap').style.display = 'none';
  document.getElementById('hybrid-area-wrap').style.display = 'none';
  document.getElementById('tz-file-name').textContent = '';
  // Сброс тогглов блоков
  ['b-psychology','b-family','b-replan','b-engineering','b-budget','b-style','b-materials','b-rooms'].forEach(function(id){
    document.getElementById(id).classList.add('on');
  });
  document.getElementById('b-services').classList.remove('on');
  renderQuestions(); renderExtraDrawings(); goStep(1);
}

function editTemplate(i) {
  editingIndex = i;
  var t = templates[i];
  document.getElementById('tpl-name').value = t.name || '';
  document.getElementById('tpl-desc').value = t.desc || '';
  selectedTZ = t.tz || 'm2';
  customQuestions = t.customQ ? t.customQ.slice() : [];
  extraDrawings = t.extraDrawings ? t.extraDrawings.slice() : [];
  document.querySelectorAll('.drawing-chip').forEach(function(c){
    c.classList.toggle('selected', (t.drawings||[]).includes(c.dataset.d));
  });
  document.querySelectorAll('.tz-card').forEach(function(c){
    c.classList.toggle('selected', c.dataset.tz === selectedTZ);
  });
  document.getElementById('upload-area-wrap').style.display = selectedTZ==='upload' ? 'block' : 'none';
  document.getElementById('hybrid-area-wrap').style.display = selectedTZ==='hybrid' ? 'block' : 'none';
  // Восстановить блоки
  var blocks = t.blocks || {};
  ['psychology','family','replan','engineering','budget','style','materials','rooms','services'].forEach(function(b){
    var el = document.getElementById('b-'+b);
    if(el) el.classList.toggle('on', blocks[b] !== false);
  });
  renderQuestions(); renderExtraDrawings(); goStep(1);
}

function deleteTemplate(i) {
  if(!confirm('Удалить шаблон "'+templates[i].name+'"?')) return;
  templates.splice(i,1);
  saveToJB();
  renderTemplates();
}

function selectTZ(el, type) {
  selectedTZ = type;
  document.querySelectorAll('.tz-card').forEach(function(c){c.classList.toggle('selected', c.dataset.tz===type);});
  document.getElementById('upload-area-wrap').style.display = type==='upload' ? 'block' : 'none';
  document.getElementById('hybrid-area-wrap').style.display = type==='hybrid' ? 'block' : 'none';
}

function handleTZUpload(input) {
  if(input.files[0]) document.getElementById('tz-file-name').textContent = '✓ ' + input.files[0].name;
}

function addExtraDrawing() {
  var inp = document.getElementById('extra-drawing-input');
  if(!inp.value.trim()) return;
  extraDrawings.push(inp.value.trim()); inp.value = ''; renderExtraDrawings();
}
function removeExtraDrawing(i){ extraDrawings.splice(i,1); renderExtraDrawings(); }
function renderExtraDrawings() {
  var list = document.getElementById('extra-drawings-list');
  list.innerHTML = extraDrawings.map(function(d,i){
    return '<div class="q-item"><div class="q-text">'+d+'</div><button class="q-del" onclick="removeExtraDrawing('+i+')">✕</button></div>';
  }).join('');
}

function addQuestion() {
  var inp = document.getElementById('new-q');
  if(!inp.value.trim()) return;
  customQuestions.push(inp.value.trim()); inp.value = ''; renderQuestions();
}
function removeQuestion(i){ customQuestions.splice(i,1); renderQuestions(); }
function renderQuestions() {
  var list = document.getElementById('q-list');
  if(!customQuestions.length){
    list.innerHTML='<div style="color:var(--light);font-size:13px;padding:8px 0 12px">Свои вопросы не добавлены</div>';
    return;
  }
  list.innerHTML = customQuestions.map(function(q,i){
    return '<div class="q-item"><div class="q-text">'+q+'</div><button class="q-del" onclick="removeQuestion('+i+')">✕</button></div>';
  }).join('');
}

function buildSummary() {
  var drawings = [];
  document.querySelectorAll('.drawing-chip.selected').forEach(function(c){
    drawings.push(DRAWING_NAMES[c.dataset.d]||c.dataset.d);
  });
  if(extraDrawings.length) drawings = drawings.concat(extraDrawings);
  var extras = [];
  if(document.getElementById('tog-vis3d').classList.contains('on')) extras.push('3D-визуализация');
  if(document.getElementById('tog-collage').classList.contains('on')) extras.push('Коллаж/мудборд');
  if(document.getElementById('tog-spec-furniture').classList.contains('on')) extras.push('Спецификация мебели');
  if(document.getElementById('tog-spec-materials').classList.contains('on')) extras.push('Спецификация материалов');
  if(document.getElementById('tog-spec-light').classList.contains('on')) extras.push('Спецификация освещения');
  if(document.getElementById('tog-estimate').classList.contains('on')) extras.push('Сметный расчёт');
  if(document.getElementById('tog-supervision').classList.contains('on')) extras.push('Авторский надзор');
  if(document.getElementById('tog-purchase').classList.contains('on')) extras.push('Управление закупками');
  if(document.getElementById('tog-build').classList.contains('on')) extras.push('Управление ремонтом');
  var name = document.getElementById('tpl-name').value || '—';
  document.getElementById('summary-grid').innerHTML =
    '<div class="sum-block full"><div class="sum-key">НАЗВАНИЕ ШАБЛОНА</div><div class="sum-val">'+name+'</div></div>'+
    '<div class="sum-block"><div class="sum-key">ЭТАЛОН ТЗ</div><div class="sum-val">'+TZ_NAMES[selectedTZ]+'</div></div>'+
    '<div class="sum-block"><div class="sum-key">ЧЕРТЕЖЕЙ В ПРОЕКТЕ</div><div class="sum-val">'+drawings.length+' позиций</div></div>'+
    '<div class="sum-block full"><div class="sum-key">ЧЕРТЕЖИ</div><div class="sum-val">'+(drawings.join(' · ')||'—')+'</div></div>'+
    (extras.length?'<div class="sum-block full"><div class="sum-key">ДОПОЛНИТЕЛЬНО</div><div class="sum-val">'+extras.join(' · ')+'</div></div>':'')+
    (customQuestions.length?'<div class="sum-block full"><div class="sum-key">СВОИ ВОПРОСЫ ('+customQuestions.length+')</div><div class="sum-val">'+customQuestions.join('<br>')+'</div></div>':'');
}

function saveTemplate() {
  var name = document.getElementById('tpl-name').value.trim();
  if(!name){ alert('Введите название шаблона'); goStep(1); return; }
  var drawings = [];
  document.querySelectorAll('.drawing-chip.selected').forEach(function(c){ drawings.push(c.dataset.d); });
  var blocks = {};
  ['psychology','family','replan','engineering','budget','style','materials','rooms','services'].forEach(function(b){
    var el = document.getElementById('b-'+b);
    if(el) blocks[b] = el.classList.contains('on');
  });
  var tpl = {
    id: editingIndex>=0 ? templates[editingIndex].id : 'tpl_'+Date.now(),
    name: name,
    desc: document.getElementById('tpl-desc').value,
    tz: selectedTZ,
    drawings: drawings,
    extraDrawings: extraDrawings.slice(),
    blocks: blocks,
    customQ: customQuestions.slice(),
    created: editingIndex>=0 ? templates[editingIndex].created : new Date().toLocaleDateString('ru')
  };
  if(editingIndex>=0) templates[editingIndex] = tpl;
  else templates.push(tpl);
  saveToJB().then(function(){ goStep(0); });
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
loadTemplates();
renderQuestions();
renderExtraDrawings();
</script>
</body>
</html>
